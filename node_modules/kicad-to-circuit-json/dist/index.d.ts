import { CircuitJsonUtilObjects } from '@tscircuit/circuit-json-util';
import { KicadPcb, KicadSch } from 'kicadts';
import { Matrix } from 'transformation-matrix';

interface ConverterContext {
    db: CircuitJsonUtilObjects;
    kicadPcb?: KicadPcb;
    kicadSch?: KicadSch;
    k2cMatSch?: Matrix;
    k2cMatPcb?: Matrix;
    netNumToName?: Map<number, string>;
    footprintUuidToComponentId?: Map<string, string>;
    symbolUuidToComponentId?: Map<string, string>;
    warnings?: string[];
    stats?: {
        components?: number;
        pads?: number;
        vias?: number;
        traces?: number;
        labels?: number;
        copper_pours?: number;
    };
}
/**
 * Base class for converter stages that process KiCad data into Circuit JSON.
 * Each stage performs a specific transformation step and can run iteratively.
 */
declare abstract class ConverterStage {
    protected ctx: ConverterContext;
    protected MAX_ITERATIONS: number;
    protected iterationCount: number;
    finished: boolean;
    constructor(ctx: ConverterContext);
    /**
     * Perform one step of the conversion process.
     * Returns true if the stage has more work to do, false if finished.
     */
    abstract step(): boolean;
    /**
     * Run this stage until completion or max iterations reached.
     */
    runUntilFinished(): void;
}

declare class KicadToCircuitJsonConverter {
    fsMap: Record<string, string>;
    ctx?: ConverterContext;
    currentStageIndex: number;
    pipeline?: ConverterStage[];
    get currentStage(): ConverterStage | undefined;
    addFile(filePath: string, content: string): void;
    _findFileWithExtension(extension: string): string | null;
    initializePipeline(): void;
    step(): boolean;
    runUntilFinished(): void;
    getOutput(): any[];
    getOutputString(): string;
    getWarnings(): string[];
    getStats(): {
        components?: number;
        pads?: number;
        vias?: number;
        traces?: number;
        labels?: number;
        copper_pours?: number;
    };
}

/**
 * InitializeSchematicContextStage sets up the coordinate transformation
 * from KiCad schematic space to Circuit JSON space.
 *
 * KiCad→CJ schematic transform (inverse of CJ→KiCad):
 * - CJ→KiCad used: translate(KICAD_CENTER) ∘ scale(15, -15) ∘ translate(-center)
 * - KiCad→CJ uses: translate(center) ∘ scale(1/15, -1/15) ∘ translate(-KICAD_CENTER)
 */
declare class InitializeSchematicContextStage extends ConverterStage {
    step(): boolean;
}

/**
 * CollectLibrarySymbolsStage extracts KiCad schematic symbols and creates:
 * - source_component entries (with ftype inferred from library id)
 * - schematic_component entries with positions
 * - schematic_port entries for each pin
 */
declare class CollectLibrarySymbolsStage extends ConverterStage {
    private processedSymbols;
    step(): boolean;
    private processSymbol;
    private getProperty;
    private inferFtype;
    private estimateSize;
    private createPorts;
    private inferPinDirection;
}

/**
 * CollectSchematicTracesStage converts KiCad schematic wires and junctions
 * into Circuit JSON schematic_trace elements.
 */
declare class CollectSchematicTracesStage extends ConverterStage {
    step(): boolean;
    private processWire;
    private processJunction;
}

/**
 * InitializePcbContextStage sets up the coordinate transformation
 * from KiCad PCB space to Circuit JSON space.
 *
 * KiCad→CJ PCB transform (inverse of CJ→KiCad):
 * - CJ→KiCad used: translate(100, 100) ∘ scale(1, -1)
 * - KiCad→CJ uses: scale(1, -1) ∘ translate(-100, -100)
 */
declare class InitializePcbContextStage extends ConverterStage {
    step(): boolean;
    private calculateBoardCenter;
}

/**
 * CollectNetsStage builds a mapping from KiCad net numbers to meaningful net names.
 * Prefers KiCad's actual net names, falls back to "Net-<n>" for unnamed nets.
 */
declare class CollectNetsStage extends ConverterStage {
    step(): boolean;
}

/**
 * CollectFootprintsStage converts KiCad footprints into Circuit JSON pcb_components,
 * along with their associated pads (SMT, plated holes, NPTH) and silkscreen text.
 */
declare class CollectFootprintsStage extends ConverterStage {
    private processedFootprints;
    step(): boolean;
}

/**
 * CollectTracesStage converts KiCad PCB segments (traces) into Circuit JSON pcb_trace elements.
 * Each segment becomes its own trace with a simple 2-point route.
 */
declare class CollectTracesStage extends ConverterStage {
    step(): boolean;
    private createTraceFromSegment;
    private mapLayer;
}

/**
 * CollectViasStage converts KiCad vias into Circuit JSON pcb_via elements.
 */
declare class CollectViasStage extends ConverterStage {
    step(): boolean;
    private processVia;
    private mapLayer;
}

/**
 * CollectZonesStage converts KiCad zones with filled copper into Circuit JSON pcb_copper_pour elements.
 * Zones define copper pours/planes that are typically used for ground and power nets.
 */
declare class CollectZonesStage extends ConverterStage {
    step(): boolean;
    private isZoneFilled;
    private createCopperPourFromZone;
    private parseZoneData;
    private extractMainPolygon;
    private extractFilledPolygons;
    private extractPointsFromPolygonEntry;
    private mapLayer;
}

/**
 * CollectGraphicsStage processes KiCad graphics elements:
 * - gr_line on Edge.Cuts → pcb_board.outline
 * - gr_text on silk layers → pcb_silkscreen_text
 * - gr_line on silk layers → pcb_silkscreen_path
 * - gr_rect on copper layers (filled) → pcb_smtpad
 * - gr_poly on copper layers (filled) → pcb_smtpad (polygon)
 */
declare class CollectGraphicsStage extends ConverterStage {
    step(): boolean;
    private createBoardOutline;
    private createSilkscreenPath;
    private processRectangle;
    private createSilkscreenText;
    private mapLayer;
    private pointsEqual;
    private pointsEqualKicad;
    private calculateWidth;
    private calculateHeight;
    private processPolygon;
    /**
     * Converts an arc defined by start, mid, and end points to multiple line segments
     * Uses the three-point arc definition to approximate the curve
     */
    private convertArcToPoints;
    /**
     * Calculate the center and radius of a circle passing through three points
     */
    private calculateArcCenter;
}

/**
 * CollectSourceTracesStage extracts logical connectivity (ratsnest) from KiCad PCB
 * by analyzing net assignments on pads and creating source_trace elements.
 *
 * This stage:
 * 1. Iterates through all footprints and their pads
 * 2. Builds a mapping of nets to connected pads
 * 3. Creates source_port elements for each pad
 * 4. Creates source_trace elements for each net that connects multiple pads
 */
declare class CollectSourceTracesStage extends ConverterStage {
    private processedNets;
    step(): boolean;
    private processFootprintPads;
    private getPadNet;
    private getOrCreateSourcePort;
    private getFootprintReference;
    private createSourceTrace;
}

export { CollectFootprintsStage, CollectGraphicsStage, CollectLibrarySymbolsStage, CollectNetsStage, CollectSchematicTracesStage, CollectSourceTracesStage, CollectTracesStage, CollectViasStage, CollectZonesStage, type ConverterContext, ConverterStage, InitializePcbContextStage, InitializeSchematicContextStage, KicadToCircuitJsonConverter };
